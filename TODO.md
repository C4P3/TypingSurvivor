# TODOリスト

このドキュメントは、Typing Survivorプロジェクトの未実装の機能や改善点を管理するためのタスクリストです。
タスクは優先度が高いと思われる順に並んでいます。

---

## 🚀 フェーズ1: ゲームフロー基盤の実装

まずは、プレイヤーがゲームを開始し、対戦し、再戦するという一連の流れを完全に機能させることが最優先です。

- [ ] **`AppManager.GameMode`連携**:

---

## 🚀 フェーズ2: コアゲームプレイの強化

- [ ] **クライアント切断時のサーバーエラーを修正**:
    - [ ] 対戦中にクライアントが切断した際、`FinishedPhase`などで存在しないプレイヤーを参照しようとしてサーバーが`ArgumentOutOfRangeException`を出す問題を解決する。`HandleClientDisconnected`の処理を堅牢にし、プレイヤー数が変動しても勝敗判定や再戦ロジックが安定して動作するように修正する。
- [ ] **再戦・スタート時のキャラクター位置を同期**:
    - [ ] ゲーム開始時や再戦直後に、キャラクターの視覚的な位置とデータ上のグリッド位置がズレている問題を解決する。サーバーが決定した位置にクライアントが即座にスナップするように、`RespawnAt`や`InitialSpawnPhase`のロジックを見直す。あるいは、ゲーム開始時に自動で1マス移動させて強制的に同期させるなどの対策を講じる。
- [ ] **マップ生成システムの刷新**:
    - [ ] **`MapGenerationRequest`モデルの導入**: `MapGenerationRequest`および`SpawnArea`クラスを定義する。
    - [ ] **`IMapGenerator`インターフェースの修正**: `Generate`メソッドに`Vector2Int offset`引数を追加し、`PerlinNoiseMapGenerator`を対応させる。
    - [ ] **`ISpawnPointStrategy`インターフェースの修正**: `GetSpawnPoints`が特定の`SpawnArea`のコンテキストで動作するように再設計する。
    - [ ] **`LevelManager`のリファクタリング**: `GenerateWorld(MapGenerationRequest request)`メソッドを実装し、ワールド構築のコアロジックとする。
    - [ ] **`GameManager`のリファクタリング**: `InitialSpawnPhase`内で、ゲームモードに基づき`MapGenerationRequest`を生成し、`LevelManager`に渡してプレイヤーをスポーンさせるように修正する。
- [ ] **全アイテムエフェクトの実装**: `Item-Effect-List.md` に記載されている未実装のアイテム効果（Star, Rocket, 妨害系など）を実装する。
- [ ] **連鎖破壊の実装**: ブロックを破壊した際、隣接する同じ色のブロックもまとめて破壊されるようにする。
- [ ] **エフェクトとサウンド**:
    - [ ] ブロック破壊時のパーティクルエフェクトやサウンドを追加する。
    - [ ] タイピング成功/失敗時のサウンドを追加する。
- [ ] **アイテムレーダーや通った通路のミニマップ導入**:
    - [ ] **アイテムレーダー**: 小さい小窓などで四隅の端に、アイテムの存在を示すミニマップ機能を実装し、追加する。
    - [ ] **通った通路のミニマップ**: 近くを通ると、ミニマップの画面に対して少し明るめの色で道があると示すマップの作製

---

## 🛠️ フェーズ3: 改善と拡張

コアなゲーム体験が固まった後、長期的な運用を見据えた改善を行います。

- [ ] **専用サーバーの接続問題の解決**:
    - [ ] コマンドライン引数 (`-dedicatedServer`) を使用して起動した専用サーバーに、クライアントが正常に接続できない問題を調査し、解決する。
- [ ] **PlayerStatusSystemの永続化**: `PlayerStatusSystem`に、Unity Gaming ServicesのCloud Saveなどを利用したセーブ/ロード機能を追加する。
- [ ] **コードクリーンアップ**:
    - [ ] `PlayerInput`の古い設計（`EnableTypingInput`など）を削除し、単一アクションマップの設計思想を徹底させる。
    - [ ] 各クラスにSummaryコメントを追加する。

---

## ✅ 完了済みタスク (Completed)

- [x] **マルチプレイの酸素管理**:
    - [x] `PlayerData`に個別の酸素レベルを追加し、`GameManager`が各プレイヤーの酸素を管理するようにした。
    - [x] `MultiPlayerStrategy`が生存プレイヤー数に基づいてゲームオーバーを判定するようにした。
    - [x] UIが各プレイヤーの酸素レベルを正しく表示し、再戦時にリセットされるようにした。
- [x] **再戦ロジックの実装**:
    - [x] `GameManager`がプレイヤーインスタンスを管理し、シーンをリロードせずにゲーム状態をリセットして再戦を開始する、堅牢なゲームループを実装した。
    - [x] `PlayerFacade`にリスポーン用のメソッドを追加し、`GameManager`が`LevelManager`と連携してプレイヤーを再配置する責務の分離されたフローを確立した。
- [x] **`GameUIManager`によるUI状態管理の実装**:
    - [x] `Game`シーン全体のUIの表示/非表示を`GamePhase`に応じて一元管理する`GameUIManager`クラスを作成した。
    - [x] リザルト画面のシンプルなUIコンポーネントを作成し、`GameUIManager`が制御できるようにした。
    - [x] `GameUIManager`がUIイベントを購読し、`GameManager`に通知するフローを実装した。
- [x] **シーン遷移戦略の策定**: 単一Gameシーン、高速再戦、動的画面分割などのゲームフロー全体を設計した。
- [x] **サーバー起動フローの改善**: コマンドライン引数でゲームモードを指定し、サーバーを直接起動できるように`ServerStartup.cs`を修正した。
- [x] **メインメニューのシーン遷移修正**: UIボタンからHost/Client/Serverとして正常にGameシーンへ遷移できるように`MainMenuManager`を修正した。
- [x] **初期化フローの改善**: `App`シーンですぐに`MainMenu`をロードし、コアサービスの初期化を非同期で行うイベント駆動のフローに修正した。
- [x] **ゲームモード戦略の実装**: `GameManager`がゲームモードに応じて`SinglePlayerStrategy`と`MultiPlayerStrategy`を切り替えられるようにした。
- [x] **プレイヤーのスポーン位置修正**: Netcodeの自動スポーンを無効化し、GameManagerがLevelManagerと連携して、グリッド中央に手動でスポーンさせるように修正した。
- [x] **お題提供クラス(WordProvider)の実装**: `TypingState`内でハードコードされているお題を、外部のクラスから動的に取得するように変更した。
- [x] **依存性注入(DI)の改善**: `AppManager`をサービスロケーターとし、`GameSceneBootstrapper`がシーンの依存性を注入するComposition Rootとして機能するようにリファクタリングした。
- [x] **PlayerStatusSystemの設計と実装の改修**: 循環参照を解消するため、`PlayerStatusSystem`をCore機能に移動し、一時効果を扱えるように再設計・実装した。
- [x] **ローマ字変換テーブルの読み込み**: `convertTable.json`を起動時に読み込み、`TypingChallenge`で利用可能にする仕組みを実装した。
- [x] **`TypingChallenge`クラスの本格実装**: Trie木を構築し、複数のタイピングパターンに対応できるようにした。
- [x] **アイテムシステムの基本実装**: アイテムのScriptableObject定義、取得ロジック、`IItemEffect`ストラテジーパターンの実装を行った。
- [x] **アイテム取得ロジックの実装**: `PlayerFacade`の移動処理に、アイテムタイルを踏んだ際に`IItemService.AcquireItem`を呼び出すロジックを追加した。
- [x] **`CameraManager`の実装**:
    - [x] プレイヤー数に応じてカメラのViewportを動的に変更し、画面分割を実現する。
    - [x] 各カメラが正しいプレイヤーを追従するようにする。
    - [x] 各プレイヤーのUI Canvasを、対応するカメラに割り当てる。