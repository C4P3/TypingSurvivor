# **Typing機能 設計ドMキュメント**

## **1\. 責務**

Typing機能は、このゲームのコアメカニクスであるタイピングに関する全てのロジックを担います。

* ひらがな（または他の言語）から、タイピング用のローマ字（または他の入力文字列）への変換。  
* プレイヤーのキー入力を受け付け、正誤判定を行う。  
* タイピングの開始、成功、失敗といったイベントを外部（Player機能）に通知する。  
* キーコンフィグや多言語対応を見据えた、柔軟な入力処理。

**設計目標:**

* **データ駆動**: ローマ字への変換ルールや、タイピングの問題文を外部データ（JSON, CSV, ScriptableObject）として管理し、ロジックとデータを分離する。  
* **Input System連携**: Unityの新しいInput Systemと協調し、アクションベースの入力と文字入力を共存させる。

## **2\. 主要コンポーネントとデータ構造**

### **2.1. ローマ字変換テーブル (convertTable.jsonなど)**

* **役割**: ひらがなと、それに対応する複数のローマ字パターンのリストを保持するデータファイル。  
* **目的**: ConvertHiraganaToRomanModelにあった巨大なswitch文を排除し、変換ルールをデータとして管理可能にします。  
* **データ構造例**:  
  \[  
    { "kana": "か", "romaji": \["ka", "ca"\] },  
    { "kana": "し", "romaji": \["shi", "si", "ci"\] },  
    { "kana": "きゃ", "romaji": \["kya", "kixya"\] }  
  \]

### **2.2. TypingChallenge.cs (データクラス)**

* **役割**: 一回のタイピングチャレンジ（お題）に関する全ての情報を保持するデータコンテナ。  
* **責務**:  
  * TypingManagerが、このクラスのインスタンスを生成・保持して、現在のタイピング状況を管理します。  
  * 表示用の日本語、判定用のひらがな、そして変換テーブルから生成された\*\*正解ローマ字パターンの木構造（Trieなど）\*\*を保持し、柔軟な入力判定（例: "sha"も"sya"もOK）を効率的に行います。

### **2.3. TypingManager.cs**

* **役割**: Player機能から依頼を受け、タイピングのUI表示と入力判定を行うメインクラス。Playerオブジェクトの子オブジェクトなどに配置されます。  
* **責務**:  
  * タイピング開始時に、問題文DBから適切な問題を選び、TypingChallengeインスタンスを生成する。  
  * UnityのInput Systemから文字入力イベント（Keyboard.current.onTextInput）を購読する。  
  * 入力された文字をTypingChallengeに渡し、正誤判定を依頼する。  
  * 判定結果をUIに反映する。  
  * タイピングが成功またはキャンセルされた際に、C\#イベント（OnTypingEnded）を発行し、PlayerFacadeに通知する。

## **3. 新Input Systemとの連携**

Player機能の設計更新に伴い、タイピングと通常操作でアクションマップを切り替える方式は廃止され、単一の`Gameplay`アクションマップに統一されました。これにより、よりシームレスな操作体験と実装の簡素化を目指します。

*   **統一されたアクションマップ**:
    *   `Move`や`CancelTyping`（Enterキー）など、ゲーム中に発生しうる全ての入力アクションが、単一の`Gameplay`アクションマップで定義されます。
*   **サーバーサイドでの入力解釈**:
    *   クライアントはプレイヤーの状態に関わらず、常に入力アクションを発行します。
    *   サーバー側（主に`PlayerFacade`）が、プレイヤーの現在の状態（`Roaming`, `Moving`, `Typing`など）を基に、その入力が持つ「意図」を判断し、適切な処理を実行します。
    *   例えば、`Typing`状態の時に`Move`入力が送られてきた場合、サーバーはこれを「タイピングを中断して移動する」という意図として解釈します。
*   **文字入力のハンドリング**:
    *   タイピングの文字入力自体は、アクションマップとは独立しています。
    *   `TypingManager`は、引き続き`Keyboard.current.onTextInput`イベントを直接購読することで文字入力を受け取ります。この仕組みはアクションマップの統一による影響を受けません。

### **全体のドキュメント:**　
[../../../README.md](../../../README.md)
### **関連ドキュメント:**
* [../Player/Player-Design.md](../Player/Player-Design.md)