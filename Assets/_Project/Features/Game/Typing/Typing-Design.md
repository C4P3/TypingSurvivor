# **Typing機能 設計ドキュメント**

## **1. 責務**

Typing機能は、このゲームのコアメカニクスであるタイピングに関する全てのロジックを担います。

*   ひらがな（または他の言語）から、タイピング用のローマ字（または他の入力文字列）への変換。
*   プレイヤーのキー入力を受け付け、正誤判定を行う。
*   タイピングの開始、成功、失敗といったイベントを外部（Player機能）に通知する。
*   キーコンジや多言語対応を見据えた、柔軟な入力処理。

**設計目標:**

*   **データ駆動**: ローマ字への変換ルールや、タイピングの問題文を外部データ（JSON, CSV）として管理し、ロジックとデータを分離する。
*   **多言語対応**: 日本語、英語、その他の言語のタイピングルールを、それぞれ独立した変換テーブルとして管理し、容易に切り替えられるようにする。

## **2. 主要コンポーネントとデータ構造**

Typing機能は、責務の分離原則に基づき、以下のコンポーネント群で構成されます。

### **2.1. データ層**

*   **`WordLists/*.csv` (CSVファイル)**
    *   **役割**: タイピングのお題となる単語リスト。
    *   **フォーマット**: `DisplayText,HiraganaText,Level,Language`
        *   `DisplayText`: 画面に表示されるテキスト（例: "寿司"）。
        *   `HiraganaText`: タイピングの元となるテキスト（例: "すし", "sushi"）。
        *   `Level`: 難易度。
        *   `Language`: 言語コード（例: "ja", "en"）。
*   **`TypingTables/*.json` (JSONファイル)**
    *   **役割**: 各言語の文字とキー入力の対応ルールを定義する変換テーブル。
*   **`TypingConversionTableSO` (ScriptableObject)**
    *   **役割**: JSONファイルをUnityアセットとしてラップし、`GameConfig`から参照可能にするための`ScriptableObject`。`WordProvider`は`GameConfig`を通じてこのアセットへの参照を受け取ります。
*   **`WordData.cs` (struct)**
    *   **役割**: CSVファイルの1行を表現するデータ構造体。

### **2.2. サービス層**

*   **`IWordProvider` / `WordProvider.cs`**
    *   **役割**: お題を提供する責務を持つサービス。
    *   **責務**:
        *   起動時にCSVファイルを読み込み、`WordData`のリストとして保持する。
        *   言語コードと変換テーブルの辞書を保持する。
        *   `GetNextChallenge()`が呼ばれると、`WordData`リストからお題を一つ選び、その言語に合った正しい変換テーブルを使って`TypingChallenge`を生成して返す。
*   **`ITypingService` / `TypingManager.cs`**
    *   **役割**: タイピング機能全体の窓口となるサービス。
    *   **責務**:
        *   `IWordProvider`からお題を取得してタイピングを開始する。
        *   UnityのInput Systemから文字入力を受け付け、`TypingChallenge`に渡して正誤判定を行う。
        *   タイピングの成功、失敗、進捗といった結果をC#イベントで外部に通知する。

### **2.3. お題管理層**

*   **`TypingChallenge.cs`**
    *   **役割**: 一回のタイピングのお題に関する「状態」を管理するデータコンテナ。
    *   **責務**:
        *   原文、タイピング用テキスト、そしてその言語に対応した正解パターンの**Trie（トライ木）**を保持する。
        *   `ProcessInput`メソッドで入力を受け付け、Trie木上の現在位置を更新し、正誤判定を返す。

### **2.4. Trie構築層 (`Builder` フォルダ)**

*   **`KanaParser.cs` / `TrieBuilder.cs` (internal)**
    *   **役割**: `WordData`のタイピング用テキストと、その言語に対応した変換テーブルを基に、Trie木を構築する。これらのクラスはタイピング機能の内部でのみ使用されます。
    *   **特徴**: 英語のように特殊ルールがない場合は、文字をそのままTrie木に登録する。日本語の場合は、促音や撥音といった複雑なルールを解決してTrie木を構築する。

## **3. 新Input Systemとの連携**

Player機能の設計更新に伴い、タイピングと通常操作でアクションマップを切り替える方式は廃止され、単一の`Gameplay`アクションマップに統一されました。これにより、よりシームレスな操作体験と実装の簡素化を目指します。

*   **統一されたアクションマップ**:
    *   `Move`や`CancelTyping`（Enterキー）など、ゲーム中に発生しうる全ての入力アクションが、単一の`Gameplay`アクションマップで定義されます。
*   **サーバーサイドでの入力解釈**:
    *   クライアントはプレイヤーの状態に関わらず、常に入力アクションを発行します。
    *   サーバー側（主に`PlayerFacade`）が、プレイヤーの現在の状態（`Roaming`, `Moving`, `Typing`など）を基に、その入力が持つ「意図」を判断し、適切な処理を実行します。
    *   例えば、`Typing`状態の時に`Move`入力が送られてきた場合、サーバーはこれを「タイピングを中断して移動する」という意図として解釈します。
*   **文字入力のハンドリング**:
    *   タイピングの文字入力自体は、アクションマップとは独立しています。
    *   `TypingManager`は、引き続き`Keyboard.current.onTextInput`イベントを直接購読することで文字入力を受け取ります。この仕組みはアクションマップの統一による影響を受けません。

### **全体のドキュメント:**
[../../../README.md](../../../README.md)
### **関連ドキュメント:**
*   [../Player/Player-Design.md](../Player/Player-Design.md)
*   [../../../Data-Management-Design.md](../../../Data-Management-Design.md)
