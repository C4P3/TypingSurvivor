# サーバーライフサイクル設計書

## 1. 概要

本ドキュメントは、専用サーバーの起動から試合、再戦、そして最終的なシャットダウンまでの一連のライフサイクル（生涯）を定義する。特に、試合終了後に再戦を可能にしつつ、不要になったサーバーが自動でシャットダウンする仕組みを確立することを目的とする。

## 2. サーバーの状態遷移

サーバーは、`GameManager.cs`内の`ServerGameLoop`コルーチンによって、以下の状態を順番に遷移する。

1.  **WaitingForPlayers**: 全プレイヤーの接続を待つ。
2.  **InitialSpawn**: マップとプレイヤーの初期スポーンを行う。
3.  **Countdown**: 試合開始のカウントダウンを行う。
4.  **Playing**: 試合中。勝敗が決定するまで継続する。
5.  **Finished**: 試合終了後の処理。本設計の主要な更新部分。

## 3. 試合終了後のフロー (FinishedPhase)

`Playing`フェーズで勝敗が決定すると、サーバーは`Finished`フェーズに移行し、以下の処理を順番に実行する。

1.  **レート計算と更新 (非同期)**:
    *   `GameManager`は`RatingService`の`HandleGameFinished`メソッドを`await`（待機）付きで呼び出す。
    *   `RatingService`は、Cloud Codeの`UpdateRatings`スクリプトを呼び出し、UGS上のEconomy（レート値）とLeaderboardをアトミックに更新する。
    *   この処理が完了すると、`RatingService`は計算された新しいレート値を`GameManager`に返す。

2.  **結果をクライアントに通知**:
    *   `GameManager`は、受け取った新レート値を含んだゲーム結果情報（`GameResultDto`）を、全クライアントに`ClientRpc`で送信する。
    *   クライアント側は、この情報を受け取り、リザルト画面に勝敗と新しいレートを表示する。

3.  **再戦待機**:
    *   `GameManager`は、クライアントからの「再戦リクエスト」を待つ状態に入る。
    *   この待機状態には、30秒のタイムアウトが設定されている。

4.  **次のラウンドへ、またはシャットダウン**:
    *   **再戦する場合**: タイムアウト前に、ルームにいる全プレイヤーから再戦リクエストを受け取った場合、`GameManager`はプレイヤーの状態をリセットし、`Countdown`フェーズに戻って次の試合を開始する。
    *   **シャットダウンする場合**: 以下のいずれかの条件を満たした場合、サーバーはシャットダウンシーケンスに移行する。
        *   再戦待機が30秒のタイムアウトに達した。
        *   再戦を待っている間に、プレイヤーの誰かが接続を切断し、再戦に必要な人数を下回った。

## 4. サーバーの自動シャットダウン

サーバーが不要になった際にリソースを自動で解放するため、以下の条件でシャットダウン処理が実行される。

*   **トリガー条件**:
    1.  `Finished`フェーズで、再戦が成立せずにタイムアウトまたは人数不足になった場合。
    2.  試合中か試合後かにかかわらず、ルームから最後のプレイヤーが接続を切断した場合。

*   **シャットダウン処理 (`ShutdownServerCoroutine`)**:
    1.  トリガー条件が満たされると、`GameManager`はシャットダウン用のコルーチンを開始する。
    2.  15秒間の待機時間（猶予期間）を設ける。これは、クライアントへの最終的なメッセージ送信などが完了するのを保証するため。
    3.  15秒後、`Application.Quit()`を呼び出し、サーバープロセスを正常に終了させる。
    4.  UGS (Multiplay) は、サーバープロセスが正常終了したことを検知し、そのサーバーインスタンスを自動的に停止（ディアロケート）する。
